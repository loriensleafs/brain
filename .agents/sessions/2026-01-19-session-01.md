# Session 2026-01-19-01: ADR-016 Session Persistence Integration Gap Analysis

**Status**: [COMPLETE]
**Date**: 2026-01-19
**Agent**: analyst
**Task**: Investigate whether session service uses Brain note persistence per ADR-016

## Objective

Determine if session state is persisting to Brain notes as designed in ADR-016, or if it remains in-memory only.

## Session Start Checklist

- [ ] Initialize Brain MCP (tool unavailable)
- [x] Read HANDOFF.md (N/A - no existing handoff)
- [x] Create session log (this file)
- [x] Verify git branch (main)

## Work Log

### Investigation

1. Searched for BrainSessionPersistence usage across codebase
2. Examined session service implementation (`apps/mcp/src/services/session/index.ts`)
3. Examined session tool implementation (`apps/mcp/src/tools/session/index.ts`)
4. Examined Inngest workflows that use persistence
5. Reviewed ADR-016 design specification

### Key Findings

**CRITICAL GAP IDENTIFIED**: Session service does NOT call BrainSessionPersistence.

**Evidence**:

- `setSession()` function only updates in-memory `sessionStore` (line 443)
- No `saveSession()` calls in session service
- No persistence integration in session tool handler
- Brain persistence is only used by Inngest workflows

**Inngest Workflows DO Use Persistence**:

- `sessionProtocolStart.ts`: Calls `persistence.saveSession()` (line 492)
- `orchestratorAgentInvoked.ts`: Calls `persistence.saveSession()` (line 261)
- `orchestratorAgentCompleted.ts`: Calls `persistence.saveSession()` (line 485)

**Architecture**:

- `BrainSessionPersistence` class exists and is fully implemented (485 lines)
- Comprehensive tests exist for persistence layer (520 lines, 20+ tests)
- Service re-exports persistence classes (lines 571-578)
- But actual session mutations do NOT call persistence

**Two-Tier Architecture**:

1. Workflow-driven updates: Persist to Brain notes (survives restarts)
2. Direct tool updates: In-memory only (lost on restart)

### Analysis Findings

**Gap Metrics**:

- Functions calling `saveSession()`: 3 (all in Inngest workflows)
- Functions mutating session state: 6 (setSession, withModeChange, withTaskUpdate, withFeatureUpdate, withProtocolStart, withProtocolEnd)
- Functions calling persistence after mutation: 0

**Integration Status**:

| Component | Persistence Integration |
|-----------|------------------------|
| Session Service (index.ts) | [FAIL] No integration |
| Session Tool (tools/session/index.ts) | [FAIL] No integration |
| Inngest Workflows | [PASS] Fully integrated |
| Persistence Layer | [PASS] Fully implemented |

**ADR-016 Design Intent**:

From ADR-016 (line 9): "State is persisted to Brain notes via BrainSessionPersistence."

The design expected ALL session state changes to persist, not just workflow-driven changes.

**Recommendations**:

| Priority | Recommendation | Effort |
|----------|----------------|--------|
| P0 | Integrate persistence into `setSession()` | 2-4 hours |
| P1 | Add integration tests for tool persistence | 1-2 hours |
| P2 | Document persistence architecture | 30 minutes |

## Session End Checklist

- [x] Complete session log
- [ ] Update Brain memory (tool unavailable)
- [x] Run markdown lint
- [x] Commit changes
- [ ] Validation script (N/A for analysis tasks)

## Deliverables

- [x] Analysis document: `.agents/analysis/009-session-persistence-integration-gap.md`

## Evidence

| Requirement | Evidence |
|-------------|----------|
| Analysis complete | `.agents/analysis/009-session-persistence-integration-gap.md` created |
| Gap identified | Persistence layer exists but not integrated into session service |
| Recommendations provided | P0/P1/P2 priorities with effort estimates |
| Sources documented | 7 files examined, all sources listed |
